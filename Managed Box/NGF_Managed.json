{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Barracuda NextGen Firewall - Managed Box",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Instance Settings"
               },
               "Parameters":[
                  "ReleaseVersion",
                  "InstanceType",
                  "LicenceMode",
                  "PrivateIpAddress",
                  "SubnetId",
                  "IAMProfile"
               ]
            },
            {
               "Label":{
                  "default":"NextGen Control Center Settings"
               },
               "Parameters":[
                  "CCIPAddress",
                  "CCRange",
                  "CCCluster",
                  "CCBoxname",
                  "CCUser",
                  "CCPassword"
               ]
            }
         ],
         "ParameterLabels":{
            "ReleaseVersion":{
               "default":"Release Version"
            },
            "InstanceType":{
               "default":"Instance Type"
            },
            "LicenceMode":{
               "default":"License Mode"
            },
            "PrivateIpAddress":{
               "default":"Private IP Address"
            },
            "SubnetId":{
               "default":"Subnet physical ID"
            },
            "IAMProfile":{
               "default":"IAM Profile"
            },
            "CCIPAddress":{
               "default":"Control Center IP address"
            },
            "CCRange":{
               "default":"Control Center Range ID"
            },
            "CCCluster":{
               "default":"Control Center Cluster Name"
            },
            "CCBoxname":{
               "default":"Box Name"
            },
            "CCUser":{
               "default":"Control Center username"
            },
            "CCPassword":{
               "default":"Control Center password/key"
            }
         }
      }
   },
   "Parameters":{
      "LicenceMode":{
         "Description":"Select the license type.",
         "Type":"String",
         "Default":"Hourly",
         "AllowedValues":[
            "Hourly",
            "BYOL"
         ]
      },
      "ReleaseVersion":{
         "Description":"Which release do you want to deploy?",
         "Type":"String",
         "Default":"9.0.4",
         "AllowedValues":[
            "8.3.3",
            "9.0.4"
         ]
      },
      "InstanceType":{
         "Description":"Select the EC2 instance type, Recommended: c5, c5n, m5 or t3",
         "Type":"String",
         "Default":"c5.large",
         "AllowedValues":[
            "t3.small",
            "t3.medium",
            "t3.xlarge",
            "m5.large",
            "m5.xlarge",
            "m5.2xlarge",
            "c5.large",
            "c5.xlarge",
            "c5.2xlarge",
            "c5n.large",
            "c5n.xlarge",
            "c5n.2xlarge"
         ],
         "ConstraintDescription":"must be a valid EC2 instance type available in your region."
      },
      "IAMProfile":{
         "Description":"(optional) Select the IAM Role for the NextGen Firewall.",
         "Type":"String",
         "Default":"NextGenFirewallRole"
      },
      "CCIPAddress":{
         "Description":"IP Address or hostname of the CC",
         "Type":"String"
      },
      "CCUser":{
         "Description":"(optional) User on the CC used to retrieve the PAR file. Leave empty to use PAR File Retrieval Key.",
         "Type":"String"
      },
      "CCPassword":{
         "Description":"Password of the CC User / PAR File Retrieval Key",
         "Type":"String",
         "NoEcho":true
      },
      "CCCluster":{
         "Description":"Name of the Cluster on the CC",
         "Type":"String"
      },
      "CCRange":{
         "Description":"Name of the Range on the CC",
         "Type":"Number",
         "Default":"1"
      },
      "CCBoxname":{
         "Description":"Name of the Box on the CC",
         "Type":"String"
      },
      "PrivateIpAddress":{
         "Description":"Private IP of the Box in the AWS subnet. Leave empty to auto-assign.",
         "Type":"String"
      },
      "SubnetId":{
         "Description":"The Id of the subnet in which the managed box is deployed",
         "Type":"AWS::EC2::Subnet::Id"
      }
   },
   "Mappings":{
      "amiMapMap":{
         "8.3.3":{
            "mapName":"amiMapv833"
         },
         "9.0.4":{
            "mapName":"amiMapv904"
         }
      },
      "amiMapv833":{
         "us-east-1":{
            "Hourly":"ami-0057f77811485311f",
            "BYOL":"ami-0a87aa89d43dd54b5"
         },
         "us-east-2":{
            "Hourly":"ami-089bbc53d9c9f6b49",
            "BYOL":"ami-00fb5b727c1e44e84"
         },
         "us-west-1":{
            "Hourly":"ami-09b069f5303516d98",
            "BYOL":"ami-0d01d86b2b63ec1db"
         },
         "us-west-2":{
            "Hourly":"ami-0b8fca301c229702f",
            "BYOL":"ami-0be24f6e0aad711bd"
         },
         "ap-south-1":{
            "Hourly":"ami-08fcff2f6b0d184f1",
            "BYOL":"ami-039f0c4f869cf7418"
         },
         "ap-northeast-3":{
            "Hourly":"ami-027db5b16ea37d059",
            "BYOL":"ami-012549169fcd2ac96"
         },
         "ap-northeast-2":{
            "Hourly":"ami-07545ae677b1a3780",
            "BYOL":"ami-0ceb324f4e9a344df"
         },
         "ap-southeast-1":{
            "Hourly":"ami-0db2591b69fb86f98",
            "BYOL":"ami-0195b012295a4b099"
         },
         "ap-southeast-2":{
            "Hourly":"ami-04fa5ae43d41c5c65",
            "BYOL":"ami-0e05f4218ccc83e19"
         },
         "ap-northeast-1":{
            "Hourly":"ami-03f68ba9f81638719",
            "BYOL":"ami-0e35c74d12df3f354"
         },
         "ca-central-1":{
            "Hourly":"ami-0c087d5e20f963e33",
            "BYOL":"ami-03882fbcd0756e229"
         },
         "eu-central-1":{
            "Hourly":"ami-0528a65148741e2df",
            "BYOL":"ami-0b4dce0dad88d9cee"
         },
         "eu-west-1":{
            "Hourly":"ami-0db5b1acc6cdefec0",
            "BYOL":"ami-06b1112c64e245856"
         },
         "eu-west-2":{
            "Hourly":"ami-07f009686642fc4c4",
            "BYOL":"ami-0cf8135584c0405aa"
         },
         "eu-west-3":{
            "Hourly":"ami-0559d0e00962da209",
            "BYOL":"ami-0f323a1eaf8d8c278"
         },
         "eu-north-1":{
            "Hourly":"ami-0cb0dddd5353fdb73",
            "BYOL":"ami-0e09a80ea4b115414"
         },
         "sa-east-1":{
            "Hourly":"ami-088fb709e478c6370",
            "BYOL":"ami-0a880e7384fcb4ed9"
         }
      },
      "amiMapv904":{
        "us-east-1":{
           "Hourly":"ami-08895dd0fbaaf57fd",
           "BYOL":"ami-0ad4a40df130c7827"
        },
        "us-east-2":{
           "Hourly":"ami-002ec9e71b7aad9a9",
           "BYOL":"ami-07ae4eeb4113cb64b"
        },
        "us-west-1":{
           "Hourly":"ami-0ce19ab56fa7b1d66",
           "BYOL":"ami-01f46f5f4bd888c2e"
        },
        "us-west-2":{
           "Hourly":"ami-0efcd924afddaf0ce",
           "BYOL":"ami-0129daba5c752d495"
        },
        "ap-south-1":{
           "Hourly":"ami-05514a781f24fc54e",
           "BYOL":"ami-0a3236ee73cd072ba"
        },
        "ap-northeast-3":{
           "Hourly":"ami-06a28b671645266d4",
           "BYOL":"ami-0254c1771a2aa223f"
        },
        "ap-northeast-2":{
           "Hourly":"ami-064ec71dc0c60766f",
           "BYOL":"ami-07ffb569192bbe7ff"
        },
        "ap-southeast-1":{
           "Hourly":"ami-01be37ccdbcacaab5",
           "BYOL":"ami-01a27bc2dc81a8e7e"
        },
        "ap-southeast-2":{
           "Hourly":"ami-08b3c926568af5539",
           "BYOL":"ami-02dcebbac184a8000"
        },
        "ap-northeast-1":{
           "Hourly":"ami-07cbffd74f1716d49",
           "BYOL":"ami-0e5532ae5e7d74dfa"
        },
        "ca-central-1":{
           "Hourly":"ami-0053ce24ffaa71dd3",
           "BYOL":"ami-04f6e199ea58f4b8b"
        },
        "eu-central-1":{
           "Hourly":"ami-04c0d34e012354fcf",
           "BYOL":"ami-07a54748a43ef62ed"
        },
        "eu-west-1":{
           "Hourly":"ami-0fd5bdcbee51abbb3",
           "BYOL":"ami-0a2c287f77c554a16"
        },
        "eu-west-2":{
           "Hourly":"ami-0f803ead6ae0f80e2",
           "BYOL":"ami-05d571b42c670bbaf"
        },
        "eu-west-3":{
           "Hourly":"ami-06211c9de56731379",
           "BYOL":"ami-0fa8f988bfbcc213c"
        },
        "eu-north-1":{
           "Hourly":"ami-0019543db566adbeb",
           "BYOL":"ami-01f4638194ea9945e"
        },
        "sa-east-1":{
           "Hourly":"ami-0f7bcca1da137c3c2",
           "BYOL":"ami-0fda9ac629615610f"
        }
     }
    },
   "Conditions":{
      "NoBoxPrivateIp":{
         "Fn::Equals":[
            {
               "Ref":"PrivateIpAddress"
            },
            ""
         ]
      },
      "SharedKeyAuth":{
         "Fn::Equals":[
            {
               "Ref":"CCUser"
            },
            ""
         ]
      }
   },
   "Resources":{
      "ManagedBox":{
         "Type":"AWS::EC2::Instance",
         "CreationPolicy":{
            "ResourceSignal":{
               "Count":"1",
               "Timeout":"PT15M"
            }
         },
         "Properties":{
            "ImageId":{
               "Fn::FindInMap":[
                  {
                     "Fn::FindInMap":[
                        "amiMapMap",
                        {
                           "Ref":"ReleaseVersion"
                        },
                        "mapName"
                     ]
                  },
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Ref":"LicenceMode"
                  }
               ]
            },
            "InstanceType":{
               "Ref":"InstanceType"
            },
            "IamInstanceProfile":{
               "Ref":"IAMProfile"
            },
            "SourceDestCheck":false,
            "NetworkInterfaces":[
               {
                  "AssociatePublicIpAddress":true,
                  "DeleteOnTermination":true,
                  "DeviceIndex":"0",
                  "PrivateIpAddress":{
                     "Fn::If":[
                        "NoBoxPrivateIp",
                        {
                           "Ref":"AWS::NoValue"
                        },
                        {
                           "Ref":"PrivateIpAddress"
                        }
                     ]
                  },
                  "SubnetId":{
                     "Ref":"SubnetId"
                  }
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Ref":"CCBoxname"
                  }
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash\n\n",
                        {
                           "Fn::Sub":"echo '${CCPassword}' | /opt/phion/bin/getpar"
                        },
                        {
                           "Fn::Sub":" -a ${CCIPAddress}"
                        },
                        {
                           "Fn::Sub":" -r ${CCRange}"
                        },
                        {
                           "Fn::Sub":" -c ${CCCluster}"
                        },
                        {
                           "Fn::Sub":" -b ${CCBoxname}"
                        },
                        {
                           "Fn::If":[
                              "SharedKeyAuth",
                              "",
                              {
                                 "Fn::Join":[
                                    "",
                                    [
                                       " -u ",
                                       {
                                          "Ref":"CCUser"
                                       }
                                    ]
                                 ]
                              }
                           ]
                        },
                        " -d /opt/phion/update/box.par -s",
                        " --verbosity 10 ",
                        " >> /tmp/getpar.log",
                        " && /opt/aws/bin/cfn-signal --success true --resource ManagedBox ",
                        {
                           "Fn::Sub":"--stack ${AWS::StackName} --region ${AWS::Region}"
                        },
                        " || /opt/aws/bin/cfn-signal -e 1 --resource ManagedBox  ",
                        {
                           "Fn::Sub":"--stack ${AWS::StackName} --region ${AWS::Region}"
                        }
                     ]
                  ]
               }
            }
         }
      }
   }
}