{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Barracuda CloudGen Firewall - HA Cluster with eip shifting",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Instance Settings"
               },
               "Parameters":[
                  "InstanceType",
                  "LicenceMode",
                  "ReleaseVersion"
               ]
            },
            {
               "Label":{
                  "default":"Network Settings"
               },
               "Parameters":[
                  "VpcAddress",
                  "CGF1MIP",
                  "CGF2MIP",
                  "Zone1",
                  "Zone2"
               ]
            }
         ],
         "ParameterLabels":{
            "InstanceType":{
               "default":"Instance Type"
            },
            "IAMProfile":{
               "default":"IAM Profile Name"
            },
            "CGF1MIP":{
               "default":"Primary Firewall IP"
            },
            "CGF2MIP":{
               "default":"Secondary Firewall IP"
            },
            "Zone1":{
               "default":"AZ for Primary CGF"
            },
            "Zone2":{
               "default":"AZ for Secondary CGF"
            }
         }
      }
   },
   "Parameters":{
      "Prefix":{
         "Type":"String",
         "Default":"CGFHA",
         "Description":"Enter the prefix prepended to resources of this template"
      },
      "InstanceType":{
         "Description":"Select the EC2 instance type, Recommended: c5, m5 or t3",
         "Type":"String",
         "Default":"c5.large",
         "AllowedValues":[
            "t2.small",
            "t3.small",
            "t3.medium",
            "t3.large",
            "m5.large",
            "m5.xlarge",
            "m5.2xlarge",
            "c5.large",
            "c5.xlarge",
            "c5.2xlarge"
         ]
      },
      "LicenceMode":{
         "Description":"Select the license type.",
         "Type":"String",
         "Default":"Hourly",
         "AllowedValues":[
            "Hourly",
            "BYOL"
         ]
      },
      "ReleaseVersion":{
         "Description":"Which release do you want to deploy?",
         "Type":"String",
         "Default":"8.3.0",
         "AllowedValues":[
            "8.0.5",
            "8.2.1",
            "8.3.0"
         ]
      },
      "EnableREST":{
         "Description":"Enable REST service on firewall by default",
         "Type":"String",
         "Default":"No",
         "AllowedValues":[
            "Yes",
            "No"
         ]
      },
      "IAMProfile":{
         "Description":"Select the IAM Role for the Firewall. Check Barracuda Campus (https://campus.barracuda.com/doc/95259350/) for more details",
         "Type":"String",
         "Default":"NextGenFirewallRole"
      },
      "CGF1MIP":{
         "Type":"String",
         "Default":"192.168.1.10",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})"
      },
      "CGF2MIP":{
         "Type":"String",
         "Default":"192.168.2.10",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})"
      },
      "Zone1":{
         "Type":"AWS::EC2::AvailabilityZone::Name",
         "Description":"Availability Zone for primary firewall"
      },
      "Zone2":{
         "Type":"AWS::EC2::AvailabilityZone::Name",
         "Description":"Availability Zone for secondary firewall"
      },
      "VpcAddress":{
         "Description":"IP address space for new VPC",
         "Type":"String",
         "Default":"192.168.0.0/16",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
         "ConstraintDescription":"Use valid CIDR notation"
      }
   },
   "Mappings":{
      "amiMapMap":{
         "8.0.5":{
            "mapName":"amiMapv805"
         },
         "8.2.1":{
            "mapName":"amiMapv821"
         },
         "8.3.0":{
            "mapName":"amiMapv830"
         }
      },
      "amiMapv805":{
         "us-east-1":{
            "Hourly":"ami-07570d14ecc6d753b",
            "BYOL":"ami-0569830c65eafd424"
         },
         "us-east-2":{
            "Hourly":"ami-0d77d90f71f12fba8",
            "BYOL":"ami-00ba624f65f4e9978"
         },
         "us-west-1":{
            "Hourly":"ami-035cbf9456923d13e",
            "BYOL":"ami-03c116b5ea4390001"
         },
         "us-west-2":{
            "Hourly":"ami-0e5dd9b420e41328b",
            "BYOL":"ami-06745e2b44b269cf0"
         },
         "ap-northeast-3":{
            "Hourly":"ami-0102c282132faf2b1",
            "BYOL":"ami-08aa0a3dd2653c27c"
         },
         "ap-southeast-1":{
            "Hourly":"ami-0efef200246fab974",
            "BYOL":"ami-0e1ad7dfea5ccb743"
         },
         "ap-southeast-2":{
            "Hourly":"ami-02c97a3294f690c00",
            "BYOL":"ami-081f3635d890c77ba"
         },
         "ap-northeast-1":{
            "Hourly":"ami-08cec4fed243531c1",
            "BYOL":"ami-0cfd25214276952eb"
         },
         "ca-central-1":{
            "Hourly":"ami-02542102565f2e9e9",
            "BYOL":"ami-0cfa82a87f4d509a5"
         },
         "eu-central-1":{
            "Hourly":"ami-0bb8e575294ff0eb9",
            "BYOL":"ami-0f8c7793cf68789d8"
         },
         "eu-west-1":{
            "Hourly":"ami-0fbb2bb1f9bb94ddd",
            "BYOL":"ami-08f45e2aac7c603ce"
         },
         "eu-west-2":{
            "Hourly":"ami-008b756cb6590e805",
            "BYOL":"ami-0be81758b47cef977"
         },
         "sa-east-1":{
            "Hourly":"ami-04db38c5d9e59bbec",
            "BYOL":"ami-03ad6e4f2a0634f31"
         }
      },
      "amiMapv821":{
         "us-east-1":{
            "Hourly":"ami-06626e94a994ebb55",
            "BYOL":"ami-06ccb7d96ef307528"
         },
         "us-east-2":{
            "Hourly":"ami-078ed482a8f9491d4",
            "BYOL":"ami-049f1c062bb15c3c3"
         },
         "us-west-1":{
            "Hourly":"ami-07a4e430871439bd3",
            "BYOL":"ami-0c388f75a4ef7e81c"
         },
         "us-west-2":{
            "Hourly":"ami-0c5a6d0536959f26a",
            "BYOL":"ami-0cc071cf047b42c97"
         },
         "ap-northeast-3":{
            "Hourly":"ami-065eac356de75eb0c",
            "BYOL":"ami-0526bddabeb47b68e"
         },
         "ap-southeast-1":{
            "Hourly":"ami-09f3afbc3b694c882",
            "BYOL":"ami-04355821a06841826"
         },
         "ap-southeast-2":{
            "Hourly":"ami-055902f1e1c7d3fe7",
            "BYOL":"ami-090841fa54dd58d0a"
         },
         "ap-northeast-1":{
            "Hourly":"ami-000d04af5c900a649",
            "BYOL":"ami-051e6cdac669c44c1"
         },
         "ca-central-1":{
            "Hourly":"ami-0df68afa8277df8b3",
            "BYOL":"ami-0dd0482612d5724ba"
         },
         "eu-central-1":{
            "Hourly":"ami-08183a86c2102371c",
            "BYOL":"ami-03a7e2b5cd9e295af"
         },
         "eu-west-1":{
            "Hourly":"ami-080f56021f42687be",
            "BYOL":"ami-0e0dac9a920663dd8"
         },
         "eu-west-2":{
            "Hourly":"ami-0ea695b18dcc775e2",
            "BYOL":"ami-06f4a60ebad16e1fe"
         },
         "sa-east-1":{
            "Hourly":"ami-0430115dfd1f17d53",
            "BYOL":"ami-0ef9dd4b0a6be4e7f"
         }
      },
      "amiMapv830":{
         "us-east-1":{
            "Hourly":"ami-08502036b50261eff",
            "BYOL":"ami-0eb58079ea6067538"
         },
         "us-east-2":{
            "Hourly":"ami-01a37ea35aac51fb3",
            "BYOL":"ami-0a9359e96131989fe"
         },
         "us-west-1":{
            "Hourly":"ami-0ef07a7685a119cc9",
            "BYOL":"ami-007d0429e8b88a6c4"
         },
         "us-west-2":{
            "Hourly":"ami-080ba652367fc8a4a",
            "BYOL":"ami-078622545858d6044"
         },
         "ap-northeast-3":{
            "Hourly":"ami-0a8884db266b4a0cb",
            "BYOL":"ami-00e091d4e096d5fcb"
         },
         "ap-southeast-1":{
            "Hourly":"ami-0f98d9860a52e8014",
            "BYOL":"ami-0ee9be9adcf7a66d3"
         },
         "ap-southeast-2":{
            "Hourly":"ami-0ba304cd3db90999e",
            "BYOL":"ami-02fc5cbb79145665f"
         },
         "ap-northeast-1":{
            "Hourly":"ami-06ddc974e8fc4c54d",
            "BYOL":"ami-0bfb140902ba7faec"
         },
         "ca-central-1":{
            "Hourly":"ami-0d3479a5f76c43d89",
            "BYOL":"ami-0131beba122852be6"
         },
         "eu-central-1":{
            "Hourly":"ami-00d8cd5b5c5260a7e",
            "BYOL":"ami-00200d6f3a8fec98d"
         },
         "eu-west-1":{
            "Hourly":"ami-062a4698272c02ea9",
            "BYOL":"ami-02da70bb6f3de83ac"
         },
         "eu-west-2":{
            "Hourly":"ami-0a2784b738789de80",
            "BYOL":"ami-058d915a3cc0eb01b"
         },
         "sa-east-1":{
            "Hourly":"ami-0f7d1ff4d98dc2d1b",
            "BYOL":"ami-0098ee5ecd3cabd56"
         }
      }
   },
   "Conditions":{
      "EnableRESTCondition":{
         "Fn::Equals":[
            {
               "Ref":"EnableREST"
            },
            "Yes"
         ]
      }
   },
   "Resources":{
      "vpcCGF":{
         "Type":"AWS::EC2::VPC",
         "Properties":{
            "CidrBlock":{
               "Ref":"VpcAddress"
            },
            "InstanceTenancy":"default",
            "EnableDnsSupport":true,
            "EnableDnsHostnames":true,
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-VPC"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "subnetPublic1":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Ref":"Zone1"
            },
            "CidrBlock":{
               "Fn::Join":[
                  ".",
                  [
                     {
                        "Fn::Select":[
                           0,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF1MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           1,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF1MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           2,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF1MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     "0/24"
                  ]
               ]
            },
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-PublicSubnet1"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "subnetPublic2":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Ref":"Zone2"
            },
            "CidrBlock":{
               "Fn::Join":[
                  ".",
                  [
                     {
                        "Fn::Select":[
                           0,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF2MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           1,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF2MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           2,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF2MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     "0/24"
                  ]
               ]
            },
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-PublicSubnet2"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "igw":{
         "Type":"AWS::EC2::InternetGateway",
         "Properties":{
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-IGW"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "igwToInternet":{
         "Type":"AWS::EC2::VPCGatewayAttachment",
         "Properties":{
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "InternetGatewayId":{
               "Ref":"igw"
            }
         }
      },
      "routeTablePublic":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-RouteTablePublic"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "PublicRoute":{
         "Type":"AWS::EC2::Route",
         "DependsOn":"igwToInternet",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePublic"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "GatewayId":{
               "Ref":"igw"
            }
         }
      },
      "routeTableToSubnetPublic1":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePublic"
            },
            "SubnetId":{
               "Ref":"subnetPublic1"
            }
         }
      },
      "routeTableToSubnetPublic2":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePublic"
            },
            "SubnetId":{
               "Ref":"subnetPublic2"
            }
         }
      },
      "routeTablePrivate":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-RouteTablePrivate"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "PrivateRoute":{
         "Type":"AWS::EC2::Route",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePrivate"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "InstanceId":{
               "Ref":"instanceCGF1"
            }
         }
      },
      "securityGroupCGF":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Allow All Traffic.",
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"-1",
                  "FromPort":-1,
                  "ToPort":-1,
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-SecurityGroup"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "floatingEIP":{
         "Type":"AWS::EC2::EIP",
         "Properties":{
            "Domain":"vpc"
         }
      },
      "floatingEIPAssoc":{
         "Type":"AWS::EC2::EIPAssociation",
         "Properties":{
            "AllocationId":{
               "Fn::GetAtt":[
                  "floatingEIP",
                  "AllocationId"
               ]
            },
            "InstanceId":{
               "Ref":"instanceCGF1"
            }
         }
      },
      "instanceCGF1":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "DisableApiTermination":false,
            "InstanceInitiatedShutdownBehavior":"stop",
            "IamInstanceProfile":{
               "Ref":"IAMProfile"
            },
            "ImageId":{
               "Fn::FindInMap":[
                  {
                     "Fn::FindInMap":[
                        "amiMapMap",
                        {
                           "Ref":"ReleaseVersion"
                        },
                        "mapName"
                     ]
                  },
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Ref":"LicenceMode"
                  }
               ]
            },
            "InstanceType":{
               "Ref":"InstanceType"
            },
            "Monitoring":false,
            "SourceDestCheck":false,
            "NetworkInterfaces":[
               {
                  "DeleteOnTermination":true,
                  "Description":{
                     "Fn::Join":[
                        "",
                        [
                           "NIC CGF1 ",
                           {
                              "Ref":"Prefix"
                           }
                        ]
                     ]
                  },
                  "DeviceIndex":"0",
                  "SubnetId":{
                     "Ref":"subnetPublic1"
                  },
                  "PrivateIpAddresses":[
                     {
                        "PrivateIpAddress":{
                           "Ref":"CGF1MIP"
                        },
                        "Primary":true
                     }
                  ],
                  "GroupSet":[
                     {
                        "Ref":"securityGroupCGF"
                     }
                  ],
                  "AssociatePublicIpAddress":true
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-CGF1"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash",
                        {
                           "Fn::If":[
                              "EnableRESTCondition",
                              "/opt/phion/bin/cloud-enable-rest",
                              ""
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-init -v ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF1 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/phion/bin/cloud-setmip",
                                 {
                                    "Ref":"CGF1MIP"
                                 },
                                 "24",
                                 {
                                    "Fn::Join":[
                                       ".",
                                       [
                                          {
                                             "Fn::Select":[
                                                0,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF1MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                1,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF1MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                2,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF1MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          "1"
                                       ]
                                    ]
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo",
                                 {
                                    "Ref":"instanceCGF2"
                                 },
                                 "|/opt/phion/bin/create-dha -c -o",
                                 {
                                    "Ref":"CGF2MIP"
                                 },
                                 "-g",
                                 {
                                    "Fn::Join":[
                                       ".",
                                       [
                                          {
                                             "Fn::Select":[
                                                0,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF2MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                1,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF2MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                2,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF2MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          "1"
                                       ]
                                    ]
                                 }
                              ]
                           ]
                        },
                        "cat << EOF >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        ". /etc/phion/bin/cloud-logapi.sh",
                        "init_log box_Cloud_control aws-eip-shift",
                        "ilog \"hook script called with \\$1\"",
                        "EOF",
                        "echo \"[[ \\\"_\\$1\\\" == \\\"_HA-START\\\" ]] && {\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"/opt/aws/bin/aws ec2 associate-address",
                                 "--instance-id $(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id)",
                                 "--allocation-id ",
                                 {
                                    "Fn::GetAtt":[
                                       "floatingEIP",
                                       "AllocationId"
                                    ]
                                 },
                                 "--allow-reassociation\"",
                                 ">> /opt/phion/hooks/ha/aws-shift-eip.sh"
                              ]
                           ]
                        },
                        "echo \"ilog \\\"EIP shifting to primary initiated: \\${aws_handle}\\\"\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "echo \"}\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "chmod +x /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "cat << EOF >> /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        "if [[ \\$(head -1 /opt/phion/run/server.ctrl | cut -d \" \" -f 3) =~ ^(primary|secondary)\\$ ]]; then",
                        "MY_ID=\\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id\\`",
                        "MY_IP=\\`/opt/aws/bin/aws ec2 describe-instances --instance-id \\$MY_ID --output text | grep ASSOC | head -1 | cut -d \\$'\t' -f 4\\`",
                        "CLUSTER_CNT=\\`/opt/phion/bin/phionctrl server show | grep Boxes | xargs | tr \" \" \"\\n\" | grep -v Boxes | wc -l\\`",
                        "if [ \"_\\$1\" != \"_\\$MY_IP\" ] && [ \\$CLUSTER_CNT == \"2\" ]; then",
                        "/opt/phion/hooks/ha/aws-shift-eip.sh HA-START",
                        "fi",
                        "fi",
                        "EOF",
                        "chmod +x /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"* * * * * root /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                                 {
                                    "Ref":"floatingEIP"
                                 },
                                 "\" > /etc/cron.d/aws-check-eip-assoc"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-signal -e $? ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF1 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        }
                     ]
                  ]
               }
            }
         },
         "CreationPolicy":{
            "ResourceSignal":{
               "Timeout":"PT15M"
            }
         }
      },
      "instanceCGF2":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "DisableApiTermination":false,
            "InstanceInitiatedShutdownBehavior":"stop",
            "IamInstanceProfile":{
               "Ref":"IAMProfile"
            },
            "ImageId":{
               "Fn::FindInMap":[
                  {
                     "Fn::FindInMap":[
                        "amiMapMap",
                        {
                           "Ref":"ReleaseVersion"
                        },
                        "mapName"
                     ]
                  },
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Ref":"LicenceMode"
                  }
               ]
            },
            "InstanceType":{
               "Ref":"InstanceType"
            },
            "Monitoring":false,
            "SourceDestCheck":false,
            "NetworkInterfaces":[
               {
                  "DeleteOnTermination":true,
                  "Description":{
                     "Fn::Join":[
                        "",
                        [
                           "NIC CGF2 ",
                           {
                              "Ref":"Prefix"
                           }
                        ]
                     ]
                  },
                  "DeviceIndex":"0",
                  "SubnetId":{
                     "Ref":"subnetPublic2"
                  },
                  "PrivateIpAddresses":[
                     {
                        "PrivateIpAddress":{
                           "Ref":"CGF2MIP"
                        },
                        "Primary":true
                     }
                  ],
                  "GroupSet":[
                     {
                        "Ref":"securityGroupCGF"
                     }
                  ],
                  "AssociatePublicIpAddress":true
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-CGF2"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-init -v ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF2 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        },
                        "/opt/phion/bin/editconf -f /opt/phion/config/active/boxadm.conf -p RPASSWDENFORCE -v 0",
                        "/opt/phion/bin/editconf -f /opt/phion/config/configroot/boxadm.conf -p RPASSWDENFORCE -v 0",
                        "cat << EOF >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        ". /etc/phion/bin/cloud-logapi.sh",
                        "init_log box_Cloud_control aws-eip-shift",
                        "ilog \"hook script called with \\$1\"",
                        "EOF",
                        "echo \"[[ \\\"_\\$1\\\" == \\\"_HA-START\\\" ]] && {\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"/opt/aws/bin/aws ec2 associate-address",
                                 "--instance-id $(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id)",
                                 "--allocation-id ",
                                 {
                                    "Fn::GetAtt":[
                                       "floatingEIP",
                                       "AllocationId"
                                    ]
                                 },
                                 "--allow-reassociation\"",
                                 ">> /opt/phion/hooks/ha/aws-shift-eip.sh"
                              ]
                           ]
                        },
                        "echo \"ilog \\\"EIP shifting to secondary initiated: \\${aws_handle}\\\"\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "echo \"}\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "chmod +x /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "cat << EOF >> /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        "if [[ \\$(head -1 /opt/phion/run/server.ctrl | cut -d \" \" -f 3) =~ ^(primary|secondary)\\$ ]]; then",
                        "MY_ID=\\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id\\`",
                        "MY_IP=\\`/opt/aws/bin/aws ec2 describe-instances --instance-id \\$MY_ID --output text | grep ASSOC | head -1 | cut -d \\$'\\t' -f 4\\`",
                        "CLUSTER_CNT=\\`/opt/phion/bin/phionctrl server show | grep Boxes | xargs | tr \" \" \"\\n\" | grep -v Boxes | wc -l\\`",
                        "if [ \"_\\$1\" != \"_\\$MY_IP\" ] && [ \\$CLUSTER_CNT == \"2\" ]; then",
                        "/opt/phion/hooks/ha/aws-shift-eip.sh HA-START",
                        "fi",
                        "fi",
                        "EOF",
                        "chmod +x /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"* * * * * root /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                                 {
                                    "Ref":"floatingEIP"
                                 },
                                 "\" > /etc/cron.d/aws-check-eip-assoc"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-signal -e $? ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF2 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        }
                     ]
                  ]
               }
            }
         },
         "CreationPolicy":{
            "ResourceSignal":{
               "Timeout":"PT15M"
            }
         }
      }
   },
   "Outputs":{
      "CGFPublicIP":{
         "Description":"Public IP address of the active firewall",
         "Value":{
            "Ref":"floatingEIP"
         }
      },
      "InitialPassword":{
         "Description":"Initial password for firewall management",
         "Value":{
            "Ref":"instanceCGF1"
         }
      }
   }
}