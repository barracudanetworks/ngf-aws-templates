{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Barracuda CloudGen Firewall - HA Cluster with eip shifting",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Instance Settings"
               },
               "Parameters":[
                  "InstanceType",
                  "LicenceMode",
                  "ReleaseVersion"
               ]
            },
            {
               "Label":{
                  "default":"Network Settings"
               },
               "Parameters":[
                  "VpcAddress",
                  "CGF1MIP",
                  "CGF2MIP",
                  "Zone1",
                  "Zone2"
               ]
            }
         ],
         "ParameterLabels":{
            "InstanceType":{
               "default":"Instance Type"
            },
            "IAMProfile":{
               "default":"IAM Profile Name"
            },
            "CGF1MIP":{
               "default":"Primary Firewall IP"
            },
            "CGF2MIP":{
               "default":"Secondary Firewall IP"
            },
            "Zone1":{
               "default":"AZ for Primary CGF"
            },
            "Zone2":{
               "default":"AZ for Secondary CGF"
            }
         }
      }
   },
   "Parameters":{
      "Prefix":{
         "Type":"String",
         "Default":"CGFHA",
         "Description":"Enter the prefix prepended to resources of this template"
      },
      "InstanceType":{
         "Description":"Select the EC2 instance type, Recommended: c5, c5n, m5 or t3",
         "Type":"String",
         "Default":"c5.large",
         "AllowedValues":[
            "t3.small",
            "t3.medium",
            "t3.xlarge",
            "m5.large",
            "m5.xlarge",
            "m5.2xlarge",
            "c5.large",
            "c5.xlarge",
            "c5.2xlarge",
            "c5n.large",
            "c5n.xlarge",
            "c5n.2xlarge"
         ]
      },
      "LicenceMode":{
         "Description":"Select the license type.",
         "Type":"String",
         "Default":"Hourly",
         "AllowedValues":[
            "Hourly",
            "BYOL"
         ]
      },
            "ReleaseVersion":{
         "Description":"Which release do you want to deploy?",
         "Type":"String",
         "Default":"9.0.4",
         "AllowedValues":[
            "8.3.3",
            "9.0.4"
         ]
      },
      "EnableREST":{
         "Description":"Enable REST service on firewall by default",
         "Type":"String",
         "Default":"No",
         "AllowedValues":[
            "Yes",
            "No"
         ]
      },
      "IAMProfile":{
         "Description":"Select the IAM Role for the Firewall. Check Barracuda Campus (https://campus.barracuda.com/doc/95259350/) for more details",
         "Type":"String",
         "Default":"NextGenFirewallRole"
      },
      "CGF1MIP":{
         "Type":"String",
         "Default":"192.168.1.10",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})"
      },
      "CGF2MIP":{
         "Type":"String",
         "Default":"192.168.2.10",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})"
      },
      "Zone1":{
         "Type":"AWS::EC2::AvailabilityZone::Name",
         "Description":"Availability Zone for primary firewall"
      },
      "Zone2":{
         "Type":"AWS::EC2::AvailabilityZone::Name",
         "Description":"Availability Zone for secondary firewall"
      },
      "VpcAddress":{
         "Description":"IP address space for new VPC",
         "Type":"String",
         "Default":"192.168.0.0/16",
         "AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
         "ConstraintDescription":"Use valid CIDR notation"
      }
   },
   "Mappings":{
      "amiMapMap":{
         "8.3.3":{
            "mapName":"amiMapv833"
         },
         "9.0.4":{
            "mapName":"amiMapv904"
         }
      },
      "amiMapv833":{
         "us-east-1":{
            "Hourly":"ami-0057f77811485311f",
            "BYOL":"ami-0a87aa89d43dd54b5"
         },
         "us-east-2":{
            "Hourly":"ami-089bbc53d9c9f6b49",
            "BYOL":"ami-00fb5b727c1e44e84"
         },
         "us-west-1":{
            "Hourly":"ami-09b069f5303516d98",
            "BYOL":"ami-0d01d86b2b63ec1db"
         },
         "us-west-2":{
            "Hourly":"ami-0b8fca301c229702f",
            "BYOL":"ami-0be24f6e0aad711bd"
         },
         "ap-south-1":{
            "Hourly":"ami-08fcff2f6b0d184f1",
            "BYOL":"ami-039f0c4f869cf7418"
         },
         "ap-northeast-3":{
            "Hourly":"ami-027db5b16ea37d059",
            "BYOL":"ami-012549169fcd2ac96"
         },
         "ap-northeast-2":{
            "Hourly":"ami-07545ae677b1a3780",
            "BYOL":"ami-0ceb324f4e9a344df"
         },
         "ap-southeast-1":{
            "Hourly":"ami-0db2591b69fb86f98",
            "BYOL":"ami-0195b012295a4b099"
         },
         "ap-southeast-2":{
            "Hourly":"ami-04fa5ae43d41c5c65",
            "BYOL":"ami-0e05f4218ccc83e19"
         },
         "ap-northeast-1":{
            "Hourly":"ami-03f68ba9f81638719",
            "BYOL":"ami-0e35c74d12df3f354"
         },
         "ca-central-1":{
            "Hourly":"ami-0c087d5e20f963e33",
            "BYOL":"ami-03882fbcd0756e229"
         },
         "eu-central-1":{
            "Hourly":"ami-0528a65148741e2df",
            "BYOL":"ami-0b4dce0dad88d9cee"
         },
         "eu-west-1":{
            "Hourly":"ami-0db5b1acc6cdefec0",
            "BYOL":"ami-06b1112c64e245856"
         },
         "eu-west-2":{
            "Hourly":"ami-07f009686642fc4c4",
            "BYOL":"ami-0cf8135584c0405aa"
         },
         "eu-west-3":{
            "Hourly":"ami-0559d0e00962da209",
            "BYOL":"ami-0f323a1eaf8d8c278"
         },
         "eu-north-1":{
            "Hourly":"ami-0cb0dddd5353fdb73",
            "BYOL":"ami-0e09a80ea4b115414"
         },
         "sa-east-1":{
            "Hourly":"ami-088fb709e478c6370",
            "BYOL":"ami-0a880e7384fcb4ed9"
         }
      },
      "amiMapv904":{
        "us-east-1":{
           "Hourly":"ami-08895dd0fbaaf57fd",
           "BYOL":"ami-0ad4a40df130c7827"
        },
        "us-east-2":{
           "Hourly":"ami-002ec9e71b7aad9a9",
           "BYOL":"ami-07ae4eeb4113cb64b"
        },
        "us-west-1":{
           "Hourly":"ami-0ce19ab56fa7b1d66",
           "BYOL":"ami-01f46f5f4bd888c2e"
        },
        "us-west-2":{
           "Hourly":"ami-0efcd924afddaf0ce",
           "BYOL":"ami-0129daba5c752d495"
        },
        "ap-south-1":{
           "Hourly":"ami-05514a781f24fc54e",
           "BYOL":"ami-0a3236ee73cd072ba"
        },
        "ap-northeast-3":{
           "Hourly":"ami-06a28b671645266d4",
           "BYOL":"ami-0254c1771a2aa223f"
        },
        "ap-northeast-2":{
           "Hourly":"ami-064ec71dc0c60766f",
           "BYOL":"ami-07ffb569192bbe7ff"
        },
        "ap-southeast-1":{
           "Hourly":"ami-01be37ccdbcacaab5",
           "BYOL":"ami-01a27bc2dc81a8e7e"
        },
        "ap-southeast-2":{
           "Hourly":"ami-08b3c926568af5539",
           "BYOL":"ami-02dcebbac184a8000"
        },
        "ap-northeast-1":{
           "Hourly":"ami-07cbffd74f1716d49",
           "BYOL":"ami-0e5532ae5e7d74dfa"
        },
        "ca-central-1":{
           "Hourly":"ami-0053ce24ffaa71dd3",
           "BYOL":"ami-04f6e199ea58f4b8b"
        },
        "eu-central-1":{
           "Hourly":"ami-04c0d34e012354fcf",
           "BYOL":"ami-07a54748a43ef62ed"
        },
        "eu-west-1":{
           "Hourly":"ami-0fd5bdcbee51abbb3",
           "BYOL":"ami-0a2c287f77c554a16"
        },
        "eu-west-2":{
           "Hourly":"ami-0f803ead6ae0f80e2",
           "BYOL":"ami-05d571b42c670bbaf"
        },
        "eu-west-3":{
           "Hourly":"ami-06211c9de56731379",
           "BYOL":"ami-0fa8f988bfbcc213c"
        },
        "eu-north-1":{
           "Hourly":"ami-0019543db566adbeb",
           "BYOL":"ami-01f4638194ea9945e"
        },
        "sa-east-1":{
           "Hourly":"ami-0f7bcca1da137c3c2",
           "BYOL":"ami-0fda9ac629615610f"
        }
     }
    },
   "Conditions":{
      "EnableRESTCondition":{
         "Fn::Equals":[
            {
               "Ref":"EnableREST"
            },
            "Yes"
         ]
      }
   },
   "Resources":{
      "vpcCGF":{
         "Type":"AWS::EC2::VPC",
         "Properties":{
            "CidrBlock":{
               "Ref":"VpcAddress"
            },
            "InstanceTenancy":"default",
            "EnableDnsSupport":true,
            "EnableDnsHostnames":true,
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-VPC"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "subnetPublic1":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Ref":"Zone1"
            },
            "CidrBlock":{
               "Fn::Join":[
                  ".",
                  [
                     {
                        "Fn::Select":[
                           0,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF1MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           1,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF1MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           2,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF1MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     "0/24"
                  ]
               ]
            },
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-PublicSubnet1"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "subnetPublic2":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Ref":"Zone2"
            },
            "CidrBlock":{
               "Fn::Join":[
                  ".",
                  [
                     {
                        "Fn::Select":[
                           0,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF2MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           1,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF2MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     {
                        "Fn::Select":[
                           2,
                           {
                              "Fn::Split":[
                                 ".",
                                 {
                                    "Ref":"CGF2MIP"
                                 }
                              ]
                           }
                        ]
                     },
                     "0/24"
                  ]
               ]
            },
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-PublicSubnet2"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "igw":{
         "Type":"AWS::EC2::InternetGateway",
         "Properties":{
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-IGW"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "igwToInternet":{
         "Type":"AWS::EC2::VPCGatewayAttachment",
         "Properties":{
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "InternetGatewayId":{
               "Ref":"igw"
            }
         }
      },
      "routeTablePublic":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-RouteTablePublic"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "PublicRoute":{
         "Type":"AWS::EC2::Route",
         "DependsOn":"igwToInternet",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePublic"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "GatewayId":{
               "Ref":"igw"
            }
         }
      },
      "routeTableToSubnetPublic1":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePublic"
            },
            "SubnetId":{
               "Ref":"subnetPublic1"
            }
         }
      },
      "routeTableToSubnetPublic2":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePublic"
            },
            "SubnetId":{
               "Ref":"subnetPublic2"
            }
         }
      },
      "routeTablePrivate":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-RouteTablePrivate"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "PrivateRoute":{
         "Type":"AWS::EC2::Route",
         "Properties":{
            "RouteTableId":{
               "Ref":"routeTablePrivate"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "InstanceId":{
               "Ref":"instanceCGF1"
            }
         }
      },
      "securityGroupCGF":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Allow All Traffic.",
            "VpcId":{
               "Ref":"vpcCGF"
            },
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"-1",
                  "FromPort":-1,
                  "ToPort":-1,
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-SecurityGroup"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ]
         }
      },
      "floatingEIP":{
         "Type":"AWS::EC2::EIP",
         "Properties":{
            "Domain":"vpc"
         }
      },
      "floatingEIPAssoc":{
         "Type":"AWS::EC2::EIPAssociation",
         "Properties":{
            "AllocationId":{
               "Fn::GetAtt":[
                  "floatingEIP",
                  "AllocationId"
               ]
            },
            "InstanceId":{
               "Ref":"instanceCGF1"
            }
         }
      },
      "instanceCGF1":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "DisableApiTermination":false,
            "InstanceInitiatedShutdownBehavior":"stop",
            "IamInstanceProfile":{
               "Ref":"IAMProfile"
            },
            "ImageId":{
               "Fn::FindInMap":[
                  {
                     "Fn::FindInMap":[
                        "amiMapMap",
                        {
                           "Ref":"ReleaseVersion"
                        },
                        "mapName"
                     ]
                  },
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Ref":"LicenceMode"
                  }
               ]
            },
            "InstanceType":{
               "Ref":"InstanceType"
            },
            "Monitoring":false,
            "SourceDestCheck":false,
            "NetworkInterfaces":[
               {
                  "DeleteOnTermination":true,
                  "Description":{
                     "Fn::Join":[
                        "",
                        [
                           "NIC CGF1 ",
                           {
                              "Ref":"Prefix"
                           }
                        ]
                     ]
                  },
                  "DeviceIndex":"0",
                  "SubnetId":{
                     "Ref":"subnetPublic1"
                  },
                  "PrivateIpAddresses":[
                     {
                        "PrivateIpAddress":{
                           "Ref":"CGF1MIP"
                        },
                        "Primary":true
                     }
                  ],
                  "GroupSet":[
                     {
                        "Ref":"securityGroupCGF"
                     }
                  ],
                  "AssociatePublicIpAddress":true
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-CGF1"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash",
                        {
                           "Fn::If":[
                              "EnableRESTCondition",
                              "/opt/phion/bin/cloud-enable-rest",
                              ""
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-init -v ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF1 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/phion/bin/cloud-setmip",
                                 {
                                    "Ref":"CGF1MIP"
                                 },
                                 "24",
                                 {
                                    "Fn::Join":[
                                       ".",
                                       [
                                          {
                                             "Fn::Select":[
                                                0,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF1MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                1,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF1MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                2,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF1MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          "1"
                                       ]
                                    ]
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo",
                                 {
                                    "Ref":"instanceCGF2"
                                 },
                                 "|/opt/phion/bin/create-dha -c -o",
                                 {
                                    "Ref":"CGF2MIP"
                                 },
                                 "-g",
                                 {
                                    "Fn::Join":[
                                       ".",
                                       [
                                          {
                                             "Fn::Select":[
                                                0,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF2MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                1,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF2MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          {
                                             "Fn::Select":[
                                                2,
                                                {
                                                   "Fn::Split":[
                                                      ".",
                                                      {
                                                         "Ref":"CGF2MIP"
                                                      }
                                                   ]
                                                }
                                             ]
                                          },
                                          "1"
                                       ]
                                    ]
                                 }
                              ]
                           ]
                        },
                        "cat << EOF >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        ". /etc/phion/bin/cloud-logapi.sh",
                        "init_log box_Cloud_control aws-eip-shift",
                        "ilog \"hook script called with \\$1\"",
                        "EOF",
                        "echo \"[[ \\\"_\\$1\\\" == \\\"_HA-START\\\" ]] && {\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"/opt/aws/bin/aws ec2 associate-address",
                                 "--instance-id $(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id)",
                                 "--allocation-id ",
                                 {
                                    "Fn::GetAtt":[
                                       "floatingEIP",
                                       "AllocationId"
                                    ]
                                 },
                                 "--allow-reassociation\"",
                                 ">> /opt/phion/hooks/ha/aws-shift-eip.sh"
                              ]
                           ]
                        },
                        "echo \"ilog \\\"EIP shifting to primary initiated: \\${aws_handle}\\\"\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "echo \"}\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "chmod +x /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "cat << EOF >> /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        "if [[ \\$(head -1 /opt/phion/run/server.ctrl | cut -d \" \" -f 3) =~ ^(primary|secondary)\\$ ]]; then",
                        "MY_ID=\\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id\\`",
                        "MY_IP=\\`/opt/aws/bin/aws ec2 describe-instances --instance-id \\$MY_ID --output text | grep ASSOC | head -1 | cut -d \\$'\t' -f 4\\`",
                        "CLUSTER_CNT=\\`/opt/phion/bin/phionctrl server show | grep Boxes | xargs | tr \" \" \"\\n\" | grep -v Boxes | wc -l\\`",
                        "if [ \"_\\$1\" != \"_\\$MY_IP\" ] && [ \\$CLUSTER_CNT == \"2\" ]; then",
                        "/opt/phion/hooks/ha/aws-shift-eip.sh HA-START",
                        "fi",
                        "fi",
                        "EOF",
                        "chmod +x /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"* * * * * root /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                                 {
                                    "Ref":"floatingEIP"
                                 },
                                 "\" > /etc/cron.d/aws-check-eip-assoc"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-signal -e $? ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF1 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        }
                     ]
                  ]
               }
            }
         },
         "CreationPolicy":{
            "ResourceSignal":{
               "Timeout":"PT15M"
            }
         }
      },
      "instanceCGF2":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "DisableApiTermination":false,
            "InstanceInitiatedShutdownBehavior":"stop",
            "IamInstanceProfile":{
               "Ref":"IAMProfile"
            },
            "ImageId":{
               "Fn::FindInMap":[
                  {
                     "Fn::FindInMap":[
                        "amiMapMap",
                        {
                           "Ref":"ReleaseVersion"
                        },
                        "mapName"
                     ]
                  },
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Ref":"LicenceMode"
                  }
               ]
            },
            "InstanceType":{
               "Ref":"InstanceType"
            },
            "Monitoring":false,
            "SourceDestCheck":false,
            "NetworkInterfaces":[
               {
                  "DeleteOnTermination":true,
                  "Description":{
                     "Fn::Join":[
                        "",
                        [
                           "NIC CGF2 ",
                           {
                              "Ref":"Prefix"
                           }
                        ]
                     ]
                  },
                  "DeviceIndex":"0",
                  "SubnetId":{
                     "Ref":"subnetPublic2"
                  },
                  "PrivateIpAddresses":[
                     {
                        "PrivateIpAddress":{
                           "Ref":"CGF2MIP"
                        },
                        "Primary":true
                     }
                  ],
                  "GroupSet":[
                     {
                        "Ref":"securityGroupCGF"
                     }
                  ],
                  "AssociatePublicIpAddress":true
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "",
                        [
                           {
                              "Ref":"Prefix"
                           },
                           "-CGF2"
                        ]
                     ]
                  }
               },
               {
                  "Key":"TemplateName",
                  "Value":{
                     "Ref":"Prefix"
                  }
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-init -v ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF2 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        },
                        "/opt/phion/bin/editconf -f /opt/phion/config/active/boxadm.conf -p RPASSWDENFORCE -v 0",
                        "/opt/phion/bin/editconf -f /opt/phion/config/configroot/boxadm.conf -p RPASSWDENFORCE -v 0",
                        "cat << EOF >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        ". /etc/phion/bin/cloud-logapi.sh",
                        "init_log box_Cloud_control aws-eip-shift",
                        "ilog \"hook script called with \\$1\"",
                        "EOF",
                        "echo \"[[ \\\"_\\$1\\\" == \\\"_HA-START\\\" ]] && {\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"/opt/aws/bin/aws ec2 associate-address",
                                 "--instance-id $(/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id)",
                                 "--allocation-id ",
                                 {
                                    "Fn::GetAtt":[
                                       "floatingEIP",
                                       "AllocationId"
                                    ]
                                 },
                                 "--allow-reassociation\"",
                                 ">> /opt/phion/hooks/ha/aws-shift-eip.sh"
                              ]
                           ]
                        },
                        "echo \"ilog \\\"EIP shifting to secondary initiated: \\${aws_handle}\\\"\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "echo \"}\" >> /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "chmod +x /opt/phion/hooks/ha/aws-shift-eip.sh",
                        "cat << EOF >> /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        "if [[ \\$(head -1 /opt/phion/run/server.ctrl | cut -d \" \" -f 3) =~ ^(primary|secondary)\\$ ]]; then",
                        "MY_ID=\\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/instance-id\\`",
                        "MY_IP=\\`/opt/aws/bin/aws ec2 describe-instances --instance-id \\$MY_ID --output text | grep ASSOC | head -1 | cut -d \\$'\\t' -f 4\\`",
                        "CLUSTER_CNT=\\`/opt/phion/bin/phionctrl server show | grep Boxes | xargs | tr \" \" \"\\n\" | grep -v Boxes | wc -l\\`",
                        "if [ \"_\\$1\" != \"_\\$MY_IP\" ] && [ \\$CLUSTER_CNT == \"2\" ]; then",
                        "/opt/phion/hooks/ha/aws-shift-eip.sh HA-START",
                        "fi",
                        "fi",
                        "EOF",
                        "chmod +x /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "echo \"* * * * * root /opt/phion/bin/xcloud-aws-check-eip-assoc.sh",
                                 {
                                    "Ref":"floatingEIP"
                                 },
                                 "\" > /etc/cron.d/aws-check-eip-assoc"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              " ",
                              [
                                 "/opt/aws/bin/cfn-signal -e $? ",
                                 "         --stack ",
                                 {
                                    "Ref":"AWS::StackName"
                                 },
                                 "         --resource instanceCGF2 ",
                                 "         --region ",
                                 {
                                    "Ref":"AWS::Region"
                                 }
                              ]
                           ]
                        }
                     ]
                  ]
               }
            }
         },
         "CreationPolicy":{
            "ResourceSignal":{
               "Timeout":"PT15M"
            }
         }
      }
   },
   "Outputs":{
      "CGFPublicIP":{
         "Description":"Public IP address of the active firewall",
         "Value":{
            "Ref":"floatingEIP"
         }
      },
      "InitialPassword":{
         "Description":"Initial password for firewall management",
         "Value":{
            "Ref":"instanceCGF1"
         }
      }
   }
}